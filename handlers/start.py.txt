import asyncio
import logging
from aiogram import Bot, Dispatcher
from config import BOT_TOKEN
from handlers.start import router as start_router
from handlers.store_actions import router as store_router
from scheduler import ReportScheduler

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

async def main():
    # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–æ—Ç–∞ —Ç–∞ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
    bot = Bot(token=BOT_TOKEN)
    dp = Dispatcher()
    
    # –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Ä–æ—É—Ç–µ—Ä—ñ–≤
    dp.include_router(start_router)
    dp.include_router(store_router)
    
    # –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞ –∑–≤—ñ—Ç—ñ–≤
    scheduler = ReportScheduler(bot)
    scheduler.start_scheduler()
    
    logger.info("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ!")
    
    try:
        await dp.start_polling(bot)
    except Exception as e:
        logger.error(f"–ü–æ–º–∏–ª–∫–∞: {e}")
    finally:
        scheduler.stop_scheduler()
        await bot.session.close()

if name == "__main__":
    asyncio.run(main())
import sqlite3
import datetime
import re
from typing import List, Dict, Optional

class Database:
    def __init__(self):
        self.conn = sqlite3.connect('stores.db', check_same_thread=False)
        self.create_tables()
    
    def create_tables(self):
        cursor = self.conn.cursor()
        
        # –¢–∞–±–ª–∏—Ü—è –º–∞–≥–∞–∑–∏–Ω—ñ–≤
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS stores (
                store_id TEXT PRIMARY KEY,
                phone TEXT UNIQUE,
                address_main TEXT,
                address_additional TEXT,
                schedule TEXT,
                is_active BOOLEAN DEFAULT TRUE
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ–≤
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS store_openings (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                store_id TEXT,
                open_time DATETIME DEFAULT CURRENT_TIMESTAMP,
                user_id INTEGER,
                user_phone TEXT,
                opened_from_work_phone BOOLEAN,
                FOREIGN KEY (store_id) REFERENCES stores (store_id)
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS admins (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                full_name TEXT
            )
        ''')
        
        self.conn.commit()
    
    def normalize_phone(self, phone: str) -> str:
        """–ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–æ —Ñ–æ—Ä–º–∞—Ç—É 0671234567"""
        if not phone:
            return ""
        
        # –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ñ —Å–∏–º–≤–æ–ª–∏
        cleaned = re.sub(r'\D', '', phone)
        
        # –Ø–∫—â–æ –Ω–æ–º–µ—Ä –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ 38, –≤–∏–¥–∞–ª—è—î–º–æ 38
        if cleaned.startswith('38'):
            cleaned = cleaned[2:]
        
        # –Ø–∫—â–æ –Ω–æ–º–µ—Ä –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ 0 —ñ –º–∞—î 10 —Ü–∏—Ñ—Ä - –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ
        if cleaned.startswith('0') and len(cleaned) == 10:
            return cleaned
        
        # –Ø–∫—â–æ –Ω–æ–º–µ—Ä –±–µ–∑ 0 –∞–ª–µ –º–∞—î 9 —Ü–∏—Ñ—Ä - –¥–æ–¥–∞—î–º–æ 0
        if len(cleaned) == 9:
            return '0' + cleaned
        
        return cleaned
    
    def add_store(self, store_id: str, phone: str, address_main: str, address_additional: str, schedule: str):
        """–î–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞–≥–∞–∑–∏–Ω—É –∑ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—î—é –Ω–æ–º–µ—Ä–∞"""
        normalized_phone = self.normalize_phone(phone)
        cursor = self.conn.cursor()
        cursor.execute('''
            INSERT OR REPLACE INTO stores (store_id, phone, address_main, address_additional, schedule)
            VALUES (?, ?, ?, ?, ?)
        ''', (store_id, normalized_phone, address_main, address_additional, schedule))
        self.conn.commit()
    
    def get_store_by_phone(self, phone: str) -> Optional[Dict]:
        """–ü–æ—à—É–∫ –º–∞–≥–∞–∑–∏–Ω—É –∑–∞ –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω—É"""
        normalized_phone = self.normalize_phone(phone)
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT store_id, phone, address_main, address_additional, schedule 
            FROM stores 
            WHERE phone = ? AND is_active = TRUE
        ''', (normalized_phone,))
        row = cursor.fetchone()
        if row:
            return dict(zip(['store_id', 'phone', 'address_main', 'address_additional', 'schedule'], row))
        return None
    
    def get_all_stores(self) -> List[Dict]:
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT store_id, phone, address_main, address_additional, schedule 
            FROM stores 
            WHERE is_active = TRUE
            ORDER BY store_id
        ''')
        return [dict(zip(['store_id', 'phone', 'address_main', 'address_additional', 'schedule'], row)) 
                for row in cursor.fetchall()]
    
    def get_store_by_id(self, store_id: str) -> Optional[Dict]:
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT store_id, phone, address_main, address_additional, schedule 
            FROM stores 
            WHERE store_id = ? AND is_active = TRUE
        ''', (store_id,))
        row = cursor.fetchone()
        if row:
return dict(zip(['store_id', 'phone', 'address_main', 'address_additional', 'schedule'], row))
        return None
    
    # –ú–µ—Ç–æ–¥–∏ –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ–≤
    def mark_store_opened(self, store_id: str, user_id: int, user_phone: str = None, from_work_phone: bool = False):
        cursor = self.conn.cursor()
        # –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ, —á–∏ –Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç–æ –≤–∂–µ —Å—å–æ–≥–æ–¥–Ω—ñ
        today = datetime.datetime.now().strftime('%Y-%m-%d')
        cursor.execute('''
            SELECT id FROM store_openings 
            WHERE store_id = ? AND DATE(open_time) = ?
        ''', (store_id, today))
        
        if not cursor.fetchone():
            cursor.execute('''
                INSERT INTO store_openings (store_id, user_id, user_phone, opened_from_work_phone)
                VALUES (?, ?, ?, ?)
            ''', (store_id, user_id, user_phone, from_work_phone))
            self.conn.commit()
            return True
        return False
    
    def get_today_opened_stores(self) -> List[str]:
        cursor = self.conn.cursor()
        today = datetime.datetime.now().strftime('%Y-%m-%d')
        cursor.execute('''
            SELECT DISTINCT store_id FROM store_openings 
            WHERE DATE(open_time) = ?
        ''', (today,))
        return [row[0] for row in cursor.fetchall()]
    
    def get_not_opened_stores(self) -> List[Dict]:
        opened_stores = self.get_today_opened_stores()
        all_stores = self.get_all_stores()
        return [store for store in all_stores if store['store_id'] not in opened_stores]
    
    # –ú–µ—Ç–æ–¥–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤
    def add_admin(self, user_id: int, username: str, full_name: str):
        cursor = self.conn.cursor()
        cursor.execute('''
            INSERT OR REPLACE INTO admins (user_id, username, full_name)
            VALUES (?, ?, ?)
        ''', (user_id, username, full_name))
        self.conn.commit()
    
    def is_admin(self, user_id: int) -> bool:
        """–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
        cursor = self.conn.cursor()
        cursor.execute('SELECT user_id FROM admins WHERE user_id = ?', (user_id,))
        return cursor.fetchone() is not None
from aiogram import Router, types, F
from aiogram.filters import Command
from aiogram.types import Contact
from database import db
from keyboards.main_menu import main_menu_for_store, main_menu_for_selection, phone_keyboard
from config import ADMIN_IDS  # –î–æ–¥–∞–Ω–æ —ñ–º–ø–æ—Ä—Ç

router = Router()

# –°–ª–æ–≤–Ω–∏–∫ –¥–ª—è —Ç–∏–º—á–∞—Å–æ–≤–æ–≥–æ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
user_states = {}

@router.message(Command("start"))
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    username = message.from_user.username
    full_name = message.from_user.full_name
    
    # –î–æ–¥–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —è–∫ –∞–¥–º—ñ–Ω–∞, —è–∫—â–æ –≤—ñ–Ω –≤ —Å–ø–∏—Å–∫—É –∞–¥–º—ñ–Ω—ñ–≤
    if user_id in ADMIN_IDS:  # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ ADMIN_IDS –∑ config
        db.add_admin(user_id, username, full_name)
    
    is_admin = db.is_admin(user_id)
    
    welcome_text = """
üè™ –í—ñ—Ç–∞—é –≤ —Å–∏—Å—Ç–µ–º—ñ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –º–∞–≥–∞–∑–∏–Ω—ñ–≤!

–û–±–µ—Ä—ñ—Ç—å —Å–ø–æ—Å—ñ–± –≤—Ö–æ–¥—É:
üì± –£–≤—ñ–π—Ç–∏ –∑ —Ä–æ–±–æ—á–æ–≥–æ –Ω–æ–º–µ—Ä—É - —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∑–Ω–∞—á–∏—Ç—å –≤–∞—à –º–∞–≥–∞–∑–∏–Ω
üè™ –û–±—Ä–∞—Ç–∏ –º–∞–≥–∞–∑–∏–Ω –≤—Ä—É—á–Ω—É - —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –æ—Å–æ–±–∏—Å—Ç–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω

*–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–∞—é—Ç—å –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó*
    """
    
    await message.answer(welcome_text, reply_markup=main_menu_for_selection(is_admin))

@router.message(F.text == "üì± –£–≤—ñ–π—Ç–∏ –∑ —Ä–æ–±–æ—á–æ–≥–æ –Ω–æ–º–µ—Ä—É")
async def request_work_phone(message: types.Message):
    await message.answer(
        "üì± –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤–∞—à —Ä–æ–±–æ—á–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.\n"
        "–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω–∞–π–¥–µ –≤–∞—à –º–∞–≥–∞–∑–∏–Ω:",
        reply_markup=phone_keyboard()
    )

@router.message(F.text == "üè™ –û–±—Ä–∞—Ç–∏ –º–∞–≥–∞–∑–∏–Ω –≤—Ä—É—á–Ω—É")
async def select_store_manually(message: types.Message):
    from handlers.store_actions import show_stores_for_selection
    await show_stores_for_selection(message)

@router.message(F.text == "üîÑ –ó–º—ñ–Ω–∏—Ç–∏ –º–∞–≥–∞–∑–∏–Ω")
async def change_store(message: types.Message):
    # –û—á–∏—â–∞—î–º–æ —Å—Ç–∞–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    user_id = message.from_user.id
    if user_id in user_states:
        del user_states[user_id]
    
    is_admin = db.is_admin(user_id)
    await message.answer(
        "üîÑ –û–±–µ—Ä—ñ—Ç—å —Å–ø–æ—Å—ñ–± —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –º–∞–≥–∞–∑–∏–Ω—É:",
        reply_markup=main_menu_for_selection(is_admin)
    )

@router.message(F.contact)
async def handle_contact(message: types.Message):
    """–û–±—Ä–æ–±–∫–∞ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É"""
    contact: Contact = message.contact
    user_id = message.from_user.id
    user_phone = contact.phone_number
    
    # –®—É–∫–∞—î–º–æ –º–∞–≥–∞–∑–∏–Ω –∑–∞ –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω—É
    store = db.get_store_by_phone(user_phone)
    
    if store:
        # –ú–∞–≥–∞–∑–∏–Ω –∑–Ω–∞–π–¥–µ–Ω–æ - –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ —Å—Ç–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        user_states[user_id] = {
            'store_id': store['store_id'],
            'from_work_phone': True
        }
        
        is_admin = db.is_admin(user_id)
        
        success_text = f"""
‚úÖ –ú–∞–≥–∞–∑–∏–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ!

üè™ ID: {store['store_id']}
üìç –ê–¥—Ä–µ—Å–∞: {store['address_main']}
{store['address_additional'] if store['address_additional'] else ''}
üìû –†–æ–±–æ—á–∏–π –Ω–æ–º–µ—Ä: {store['phone']}
üïí –ì—Ä–∞—Ñ—ñ–∫: {store['schedule']}

–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–∑–Ω–∞—á–∞—Ç–∏ –º–∞–≥–∞–∑–∏–Ω –≤—ñ–¥–∫—Ä–∏—Ç–∏–º.
        """
        
        await message.answer(success_text, reply_markup=main_menu_for_store(store, is_admin))
        
    else:
        # –ú–∞–≥–∞–∑–∏–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
        is_admin = db.is_admin(user_id)
        error_text = f"""
‚ùå –ú–∞–≥–∞–∑–∏–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ

–ù–æ–º–µ—Ä {user_phone} –Ω–µ –ø—Ä–∏–≤'—è–∑–∞–Ω–∏–π –¥–æ –∂–æ–¥–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω—É.

–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:
‚Ä¢ –í–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –æ—Å–æ–±–∏—Å—Ç–∏–π –Ω–æ–º–µ—Ä –∑–∞–º—ñ—Å—Ç—å —Ä–æ–±–æ—á–æ–≥–æ
‚Ä¢ –†–æ–±–æ—á–∏–π –Ω–æ–º–µ—Ä –Ω–µ –¥–æ–¥–∞–Ω–æ –≤ —Å–∏—Å—Ç–µ–º—É
‚Ä¢ –ü–æ–º–∏–ª–∫–∞ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö

–°–ø—Ä–æ–±—É–π—Ç–µ –û–±—Ä–∞—Ç–∏ –º–∞–≥–∞–∑–∏–Ω –≤—Ä—É—á–Ω—É –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
        """
        await message.answer(error_text, reply_markup=main_menu_for_selection(is_admin))

@router.message(Command("help"))
async def cmd_help(message: types.Message):
    help_text = """
üìã –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –ø–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é:

–î–ª—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤:

üì± –£–≤—ñ–π—Ç–∏ –∑ —Ä–æ–±–æ—á–æ–≥–æ –Ω–æ–º–µ—Ä—É - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –º–∞–≥–∞–∑–∏–Ω—É
üè™ –û–±—Ä–∞—Ç–∏ –º–∞–≥–∞–∑–∏–Ω –≤—Ä—É—á–Ω—É - –≤–∏–±—ñ—Ä –º–∞–≥–∞–∑–∏–Ω—É –∑—ñ —Å–ø–∏—Å–∫—É
‚úÖ –ú–∞–≥–∞–∑–∏–Ω –≤—ñ–¥–∫—Ä–∏—Ç–∏–π - –ø–æ–∑–Ω–∞—á–∏—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–∞–≥–∞–∑–∏–Ω—É
üè™ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –º–∞–≥–∞–∑–∏–Ω - –¥–∞–Ω—ñ –≤–∞—à–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω—É
üîÑ –ó–º—ñ–Ω–∏—Ç–∏ –º–∞–≥–∞–∑–∏–Ω - –æ–±—Ä–∞—Ç–∏ —ñ–Ω—à–∏–π –º–∞–≥–∞–∑–∏–Ω

–î–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤:
üìä –°—Ç–∞—Ç—É—Å –≤—Å—ñ—Ö –º–∞–≥–∞–∑–∏–Ω—ñ–≤ - –ø–µ—Ä–µ–≥–ª—è–¥ —Å—Ç–∞—Ç—É—Å—ñ–≤
üìã –°–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω—ñ–≤ - –≤—Å—ñ –º–∞–≥–∞–∑–∏–Ω–∏ –∑ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏

–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ –∑–≤—ñ—Ç–∏:
üïí 7:50 - –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∑–≤—ñ—Ç –ø—Ä–æ –Ω–µ–≤—ñ–¥–∫—Ä–∏—Ç—ñ –º–∞–≥–∞–∑–∏–Ω–∏
üïí 8:00 - —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç –ø—Ä–æ –Ω–µ–≤—ñ–¥–∫—Ä–∏—Ç—ñ –º–∞–≥–∞–∑–∏–Ω–∏
    """
    await message.answer(help_text)
import sqlite3
import datetime
import re
from typing import List, Dict, Optional

class Database:
    def __init__(self):
        self.conn = sqlite3.connect('stores.db', check_same_thread=False)
        self.create_tables()
    
    def create_tables(self):
        cursor = self.conn.cursor()
        
        # Таблиця магазинів
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS stores (
                store_id TEXT PRIMARY KEY,
                phone TEXT UNIQUE,
                address_main TEXT,
                address_additional TEXT,
                schedule TEXT,
                is_active BOOLEAN DEFAULT TRUE
            )
        ''')
        
        # Таблиця відкриттів
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS store_openings (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                store_id TEXT,
                open_time DATETIME DEFAULT CURRENT_TIMESTAMP,
                user_id INTEGER,
                user_phone TEXT,
                opened_from_work_phone BOOLEAN,
                FOREIGN KEY (store_id) REFERENCES stores (store_id)
            )
        ''')
        
        # Таблиця адміністраторів
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS admins (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                full_name TEXT
            )
        ''')
        
        self.conn.commit()
    
    def normalize_phone(self, phone: str) -> str:
        """Нормалізація номера телефону до формату 0671234567"""
        if not phone:
            return ""
        
        # Видаляємо всі нецифрові символи
        cleaned = re.sub(r'\D', '', phone)
        
        # Якщо номер починається з 38, видаляємо 38
        if cleaned.startswith('38'):
            cleaned = cleaned[2:]
        
        # Якщо номер починається з 0 і має 10 цифр - повертаємо
        if cleaned.startswith('0') and len(cleaned) == 10:
            return cleaned
        
        # Якщо номер без 0 але має 9 цифр - додаємо 0
        if len(cleaned) == 9:
            return '0' + cleaned
        
        return cleaned
    
    def add_store(self, store_id: str, phone: str, address_main: str, address_additional: str, schedule: str):
        """Додавання магазину з нормалізацією номера"""
        normalized_phone = self.normalize_phone(phone)
        cursor = self.conn.cursor()
        cursor.execute('''
            INSERT OR REPLACE INTO stores (store_id, phone, address_main, address_additional, schedule)
            VALUES (?, ?, ?, ?, ?)
        ''', (store_id, normalized_phone, address_main, address_additional, schedule))
        self.conn.commit()
    
    def get_store_by_phone(self, phone: str) -> Optional[Dict]:
        """Пошук магазину за номером телефону"""
        normalized_phone = self.normalize_phone(phone)
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT store_id, phone, address_main, address_additional, schedule 
            FROM stores 
            WHERE phone = ? AND is_active = TRUE
        ''', (normalized_phone,))
        row = cursor.fetchone()
        if row:
            return dict(zip(['store_id', 'phone', 'address_main', 'address_additional', 'schedule'], row))
        return None
    
    def get_all_stores(self) -> List[Dict]:
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT store_id, phone, address_main, address_additional, schedule 
            FROM stores 
            WHERE is_active = TRUE
            ORDER BY store_id
        ''')
        return [dict(zip(['store_id', 'phone', 'address_main', 'address_additional', 'schedule'], row)) 
                for row in cursor.fetchall()]
    
    def get_store_by_id(self, store_id: str) -> Optional[Dict]:
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT store_id, phone, address_main, address_additional, schedule 
            FROM stores 
            WHERE store_id = ? AND is_active = TRUE
        ''', (store_id,))
        row = cursor.fetchone()
        if row:
return dict(zip(['store_id', 'phone', 'address_main', 'address_additional', 'schedule'], row))
        return None
    
    # Методи для відкриттів
    def mark_store_opened(self, store_id: str, user_id: int, user_phone: str = None, from_work_phone: bool = False):
        cursor = self.conn.cursor()
        # Спочатку перевіримо, чи не відкрито вже сьогодні
        today = datetime.datetime.now().strftime('%Y-%m-%d')
        cursor.execute('''
            SELECT id FROM store_openings 
            WHERE store_id = ? AND DATE(open_time) = ?
        ''', (store_id, today))
        
        if not cursor.fetchone():
            cursor.execute('''
                INSERT INTO store_openings (store_id, user_id, user_phone, opened_from_work_phone)
                VALUES (?, ?, ?, ?)
            ''', (store_id, user_id, user_phone, from_work_phone))
            self.conn.commit()
            return True
        return False
    
    def get_today_opened_stores(self) -> List[str]:
        cursor = self.conn.cursor()
        today = datetime.datetime.now().strftime('%Y-%m-%d')
        cursor.execute('''
            SELECT DISTINCT store_id FROM store_openings 
            WHERE DATE(open_time) = ?
        ''', (today,))
        return [row[0] for row in cursor.fetchall()]
    
    def get_not_opened_stores(self) -> List[Dict]:
        opened_stores = self.get_today_opened_stores()
        all_stores = self.get_all_stores()
        return [store for store in all_stores if store['store_id'] not in opened_stores]
    
    # Методи для адміністраторів
    def add_admin(self, user_id: int, username: str, full_name: str):
        cursor = self.conn.cursor()
        cursor.execute('''
            INSERT OR REPLACE INTO admins (user_id, username, full_name)
            VALUES (?, ?, ?)
        ''', (user_id, username, full_name))
        self.conn.commit()
    
    def is_admin(self, user_id: int) -> bool:
        """Перевірка, чи є користувач адміністратором"""
        cursor = self.conn.cursor()
        cursor.execute('SELECT user_id FROM admins WHERE user_id = ?', (user_id,))
        return cursor.fetchone() is not None